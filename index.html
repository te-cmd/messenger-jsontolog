<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Messenger JSON â†’ Log</title>
  <style>
    body { font-family: monospace; }
    .log-line { margin: 2px 0; }
    .log-link { color: blue; text-decoration: underline; cursor: pointer; }
    #media { margin-top: 20px; }
  </style>
</head>
<body>
  <h2>Messenger JSON to Log Converter</h2>
  <input type="file" id="fileInput" />
  <button id="convertBtn">Convert</button>
  <div id="output"></div>
  <div id="media"></div>
  <a id="downloadLink" style="display:none;">Download .log file</a>

  <script>
  const playableExts = [".ogg", ".wav", ".mp4", ".mp3", ".jpeg", ".jpg", ".png"];

  // List of bad words (case-sensitive!)
  const badWords = ["fuck", "Fuck", "shit", "Shit", "bitch", "Bitch", "gago", "bobo", "Bobo", "tanga", "FUCK", "TANGINAINA", "Puta", "PUTA", "HAYOPKA", "sh!t", "SH1T"];

  let swearCount = 0;
  let userSwears = {};
  let totalMessages = 0;
  let userMessages = {};

  function filterText(text, sender) {
    let result = text;
    badWords.forEach(word => {
      const regex = new RegExp(word, "g"); // case-sensitive
      if (regex.test(result)) {
        const matches = result.match(regex);
        if (matches) {
          swearCount += matches.length;
          if (!userSwears[sender]) userSwears[sender] = 0;
          userSwears[sender] += matches.length;
        }
      }
      result = result.replace(regex, match => "#".repeat(match.length));
    });
    return result;
  }

  document.getElementById("convertBtn").addEventListener("click", () => {
    swearCount = 0;
    userSwears = {};
    totalMessages = 0;
    userMessages = {};

    const fileInput = document.getElementById("fileInput").files[0];
    if (!fileInput) {
      alert("Please choose a JSON file first.");
      return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
      const data = JSON.parse(e.target.result);
      const messages = data.messages || [];

      const outputDiv = document.getElementById("output");
      outputDiv.innerHTML = "";
      const mediaDiv = document.getElementById("media");
      mediaDiv.innerHTML = "";

      const logLines = [];

      messages.forEach(msg => {
        const sender = msg.senderName || "Unknown";
        let ts = "Unknown time";

        if (msg.timestamp) {
          const d = new Date(msg.timestamp);
          if (!isNaN(d.getTime())) {
            ts = d.toISOString().replace("T", " ").split(".")[0];
          }
        }

        // Count messages
        totalMessages++;
        if (!userMessages[sender]) userMessages[sender] = 0;
        userMessages[sender]++;

        let text = msg.text && msg.text.trim() ? filterText(msg.text, sender) : "";
        let displayLine = document.createElement("div");
        displayLine.className = "log-line";

        let lineText = `[${ts}] ${sender}: `;

        if (msg.media && msg.media.length > 0) {
          msg.media.forEach(m => {
            const uri = m.uri || "";
            const lower = uri.toLowerCase();

            let tagText = playableExts.some(ext => lower.endsWith(ext))
              ? `[Media: ${uri}]`
              : `[File: ${uri}]`;

            const a = document.createElement("a");
            a.href = uri;
            a.textContent = tagText;
            a.className = "log-link";
            a.target = "_blank";

            displayLine.appendChild(document.createTextNode(lineText + (text ? text + " " : "")));
            displayLine.appendChild(a);
            lineText += (text ? text + " " : "") + tagText;
          });
        } else {
          if (!text) text = "[Empty message]";
          lineText += text;
          displayLine.textContent = lineText;
        }

        outputDiv.appendChild(displayLine);
        logLines.push(lineText);
      });

      // Show stats
      const countDiv = document.createElement("div");
      countDiv.style.marginTop = "15px";
      countDiv.style.fontWeight = "bold";
      countDiv.textContent = `Total swears detected: ${swearCount}`;
      outputDiv.appendChild(countDiv);

      if (Object.keys(userSwears).length > 0) {
        const perUserDiv = document.createElement("div");
        perUserDiv.style.marginTop = "5px";
        perUserDiv.innerHTML = "Swears per user:<br>" + 
          Object.entries(userSwears)
            .map(([user, count]) => `${user}: ${count}`)
            .join("<br>");
        outputDiv.appendChild(perUserDiv);
      }

      const msgDiv = document.createElement("div");
      msgDiv.style.marginTop = "15px";
      msgDiv.style.fontWeight = "bold";
      msgDiv.textContent = `Total messages: ${totalMessages}`;
      outputDiv.appendChild(msgDiv);

      if (Object.keys(userMessages).length > 0) {
        const perUserMsgDiv = document.createElement("div");
        perUserMsgDiv.style.marginTop = "5px";
        perUserMsgDiv.innerHTML = "Messages per user:<br>" + 
          Object.entries(userMessages)
            .map(([user, count]) => `${user}: ${count}`)
            .join("<br>");
        outputDiv.appendChild(perUserMsgDiv);
      }

      // Add stats to downloaded file
      let logText = logLines.join("\n") + 
        `\n\nTotal swears detected: ${swearCount}`;
      if (Object.keys(userSwears).length > 0) {
        logText += "\nSwears per user:\n" + 
          Object.entries(userSwears).map(([user, count]) => `${user}: ${count}`).join("\n");
      }
      logText += `\n\nTotal messages: ${totalMessages}`;
      if (Object.keys(userMessages).length > 0) {
        logText += "\nMessages per user:\n" + 
          Object.entries(userMessages).map(([user, count]) => `${user}: ${count}`).join("\n");
      }

      const blob = new Blob([logText], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const link = document.getElementById("downloadLink");
      link.href = url;
      link.download = "messenger_chat.log";
      link.style.display = "block";
      link.textContent = "Download .log file";
    };

    reader.readAsText(fileInput);
  });
  </script>
</body>
</html>
