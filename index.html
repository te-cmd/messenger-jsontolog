<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Messenger JSON to Log</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #000;
      color: #0f0;
      margin: 0;
      padding: 20px;
    }

    h1 {
      margin-bottom: 20px;
      color: #0ff;
    }

    .container {
      display: flex;
      gap: 20px;
    }

    .sidebar {
      flex: 1;
    }

    .file-btn {
      display: block;
      background: #0ff;
      color: black;
      border: none;
      border-radius: 20px;
      padding: 12px;
      margin: 10px 0;
      cursor: pointer;
      font-weight: bold;
      text-align: center;
      box-shadow: 0px 3px 6px rgba(0,0,0,0.2);
      transition: background 0.2s;
    }
    .file-btn:hover {
      background: #0cc;
    }

    .viewer {
      flex: 2;
      border: 3px solid #0ff;
      padding: 15px;
      font-family: monospace;
      white-space: pre-wrap;
      overflow-y: auto;
      max-height: 80vh;
      background: black;
      color: #0f0;
    }

    .status {
      margin-bottom: 15px;
      font-weight: bold;
      color: #ff0;
    }
  </style>
</head>
<body>
  <h1>Messenger JSON to Log</h1>
  <div class="status" id="status">No files loaded</div>

  <div class="container">
    <div class="sidebar" id="fileList">
      <!-- Buttons will be added here -->
    </div>
    <div class="viewer" id="viewer">
      Select a file to preview its log
    </div>
  </div>

  <input type="file" id="zipInput" accept=".zip" />

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script>
    const input = document.getElementById("zipInput");
    const fileList = document.getElementById("fileList");
    const viewer = document.getElementById("viewer");
    const status = document.getElementById("status");

    function formatMessengerLog(json) {
      if (!json.messages) return "Invalid Messenger JSON";

      return json.messages.map(msg => {
        const sender = msg.sender_name || "Unknown";
        const text = Array.isArray(msg.content) ? msg.content.join(" ") : (msg.content || "");
        const time = msg.timestamp_ms ? new Date(msg.timestamp_ms).toLocaleString() : "Unknown time";
        return `[${time}] ${sender}: ${text}`;
      }).reverse().join("\n");
    }

    input.addEventListener("change", async () => {
      if (!input.files.length) return;
      const file = input.files[0];
      const jszip = new JSZip();

      const contents = await jszip.loadAsync(file);
      const jsonFiles = Object.keys(contents.files).filter(f => f.endsWith(".json"));

      status.textContent = `${jsonFiles.length} json files detected!`;
      fileList.innerHTML = "";

      jsonFiles.forEach(filename => {
        const btn = document.createElement("button");
        btn.textContent = filename;
        btn.className = "file-btn";
        btn.onclick = async () => {
          const text = await contents.files[filename].async("text");
          try {
            const obj = JSON.parse(text);
            viewer.textContent = formatMessengerLog(obj);
          } catch {
            viewer.textContent = text;
          }
        };
        fileList.appendChild(btn);
      });
    });
  </script>
</body>
</html>
